# 安装宝塔面板

- Centos安装脚本


```shell
yum install -y wget && wget -O install.sh http://download.bt.cn/install/install_6.0.sh && sh install.sh ed8484bec
```

- Ubuntu/Deepin安装脚本


```shell
wget -O install.sh http://download.bt.cn/install/install-ubuntu_6.0.sh && sudo bash install.sh ed8484bec
```

--------------

# Python爬虫环境

## Centos 

### Python

​	安装**python3.10.10**

- 因为官网源下载比较慢，所以这里备份并替换为阿里云源，这样做不是必须的，视你的情况而定。


```shell
#替换为阿里云源
curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo
curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo
```

- 然后安装依赖


```shell
yum -y groupinstall "Development tools"
yum install -y ncurses-devel gdbm-devel xz-devel sqlite-devel tk-devel uuid-devel readline-devel bzip2-devel libffi-devel
yum install -y openssl-devel openssl11 openssl11-devel
```

- 编译主要需要注意的问题是设置编译FLAG，以便使用最新的openssl库。


```shell
export CFLAGS=$(pkg-config --cflags openssl11)
export LDFLAGS=$(pkg-config --libs openssl11)
```

- 开始安装


```shell
#解压然后进入目录
tar xvzf Python-3.10.10.tgz
cd Python-3.10.10

# 安装
./configure --enable-optimizations && make altinstall

# 安装完成后验证一下是否安装成功
/usr/local/bin/python3.10 --version
/usr/local/bin/pip3.10 --version
```

- 设置软链接


```shell
cd /usr/bin
    
ll | grep python

sudo rm ./python # 删除原有的软连接文件
sudo rm ./pip
sudo rm ./pip3

sudo ln -s /usr/local/python3.10/bin/python3.10 /usr/bin/python
sudo ln -s /usr/local/python3.10/bin/pip3.10 /usr/bin/pip
sudo ln -s /usr/local/python3.10/bin/pip3.10 /usr/bin/pip3
```

**注：这里我们不能将系统中的 python3 命令链接到 python3.10 版本（这里我已经踩坑），因为 python3.10 版本还是发型版本，并不是稳定版本，若更改后则会导致 Ubuntu 系统下的很多 python 文件无法打开（比如你的 gnome 终端）！**

### Chrome driver

```shell
# 搞清楚linux是32bit or 64bit
echo "You are using $(getconf LONG_BIT) bit Linux distro."

# download
wget https://dl.google.com/linux/direct/google-chrome-stable_current_x86_64.rpm

# install
sudo yum install ./google-chrome-stable_current_*.rpm

#查看版本
google-chrome --version

# 2. 上传chromedriver 安装chromedriver
sudo yum install unzip
sudo unzip chromedriver_linux64.zip
sudo cp chromedriver /usr/bin
sudo chmod +x chromedriver
sudo chromedriver --version
```

[ChromeDriver Mirror](http://npm.taobao.org/mirrors/chromedriver/)




----

## Ubuntu 

### Python

- (**python3.10.10**)

- 执行以下命令更新源：


```shell
sudo apt-get update
```


  - 执行以下命令安装 Python3 的一些依赖库：


```shell
sudo apt-get install libqgispython3.10.4
sudo apt-get install libpython3.10-stdlib
```


- 上传**python3.10.10**安装包或下载安装包


  - 开始安装(这里采用从本地上传)


```shell
#解压然后进入目录
tar xvJf Python-3.10.10.tar.xz
cd Python-3.10.10

# 安装
./configure --prefix=/usr/local/python3.10

make
sudo make install

# 安装完成后验证一下是否安装成功
/usr/local/bin/python3.10 --version
/usr/local/bin/pip3.10 --version
```


  - 设置软链接


```shell
#进入bin目录
cd /usr/bin

ll | grep python

# 删除原有的软连接文件
sudo rm ./python 
sudo rm ./pip
sudo rm ./pip3

sudo ln -s /usr/local/python3.10/bin/python3.10 /usr/bin/python
sudo ln -s /usr/local/python3.10/bin/pip3.10 /usr/bin/pip
sudo ln -s /usr/local/python3.10/bin/pip3.10 /usr/bin/pip3
```

**注：这里我们不能将系统中的 python3 命令链接到 python3.10 版本（这里我已经踩坑），因为 python3.10 版本还是发型版本，并不是稳定版本，若更改后则会导致 Ubuntu 系统下的很多 python 文件无法打开（比如你的 gnome 终端）！**

### Chrome driver

```shell
# 搞清楚linux是32bit or 64bit
echo "You are using $(getconf LONG_BIT) bit Linux distro."

# download  或者自己导入
wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb

#修复bug
sudo apt-get -f install 
# install
sudo dpkg -i google-chrome-stable_current_amd64.deb

#查看版本
google-chrome --version

# 2. 上传chromedriver 安装chromedriver
sudo apt-get install unzip
sudo unzip chromedriver_linux64.zip

# 先放到share里,然后在再bin里建立软连接
sudo mv -f chromedriver /usr/local/share/chromedriver
sudo ln -s /usr/local/share/chromedriver /usr/local/bin/chromedriver
sudo ln -s /usr/local/share/chromedriver /usr/bin/chromedriver

#修改权限
sudo chmod +x chromedriver

sudo chromedriver --version
```

[ChromeDriver Mirror](https://registry.npmmirror.com/binary.html?path=chromedriver/)



----

## 安装module

- 自动生成requirement.txt

```shell
pip freeze > requirements.txt
```

- httpx

```sh
sudo python -m pip install httpx --user
```


---



# Django后端

------

## 部署

1. 上传总Django文件

2. 在宝塔面板->网站->Python项目->添加Django项目

3. 添加所需要的数据库

4. 安装module

   1. ```shell
      #一下安装sudo和非sudo都安装一遍,防止发生错误
      #先安装依赖包
      sudo apt-get install default-libmysqlclient-dev build-essential
      
      #安装3.2版本的django,为了能匹配mysql的版本
      #
      sudo pip install django==3.2
      pip install django==3.2
      sudo pip install mysqlclient
      pip install mysqlclient
      ```

5. 如没出现问题,则开始改一些配置

   1. ```py
      #把开发者模式关掉
      DEBUG = False
      #运行所有hosts
      ALLOWED_HOSTS = ['*']
      #注释掉csrf,防止发送请求失败
      MIDDLEWARE = [
          #'django.middleware.csrf.CsrfViewMiddleware',
      ]
      #配置好你的数据库登陆信息
      DATABASES = {
          'default': {
              'ENGINE': 'django.db.backends.mysql',
              'NAME': 'server',
              'USER': 'server',
              'PASSWORD': '123456',
              'HOST': '127.0.0.1',
              'POST': 3306,
          }
      }
      #改语言和时间
      LANGUAGE_CODE = 'zh-hans'
      TIME_ZONE = 'Asia/Shanghai'
      ```

      

   

## 跨域问题

- 参考[文章](https://blog.csdn.net/weixin_67531112/article/details/127734848?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522169556999816800222851876%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=169556999816800222851876&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-127734848-null-null.142^v94^insert_down1&utm_term=django%E8%B7%A8%E5%9F%9F&spm=1018.2226.3001.4187)

- 解决跨域问题的方法

> 前端： 通过代理解决
>
> nginx代理
>
> cors解决跨域：django-cors-headers

### 后端解决

- **后端**安装跨域模块

```shell
pip install django-cors-headers
```

- 到setting.py中注册

```py
INSTALLED_APPS = (
    ...
    'corsheaders'
)
```

- 到setting.py中添加中间件


```py
MIDDLEWARE = [
    ...
    'corsheaders.middleware.CorsMiddleware',
    'django.middleware.common.CommonMiddleware',    # 这个是原本就存在的
    ...
]
```

- 到setting.py中添加如下代码


```py
CORS_ALLOW_CREDENTIALS = True
CORS_ORIGIN_ALLOW_ALL = True
# CORS_ORIGIN_WHITELIST = (
#     'http://127.0.0.1:8080',
# )
CORS_ALLOWED_ORIGINS_REGEXES=[
    r'^http://.*?$',
]
# CORS_ORIGIN_REGEXES_WHITELIST = (
#         r'^http://.*?$',
# )
CORS_ALLOW_METHODS = (
    'DELETE',
    'GET',
    'OPTIONS',
    'PATCH',
    'POST',
    'PUT',
    'VIEW',
)
 
CORS_ALLOW_HEADERS = (
    'XMLHttpRequest',
    'X_FILENAME',
    'accept-encoding',
    'authorization',
    'content-type',
    'dnt',
    'origin',
    'user-agent',
    'x-csrftoken',
    'x-requested-with',
    'Pragma',
)
```

-  设置setting.py的ALLOWED_HOSTS


```py
ALLOWED_HOSTS = ['*']
```

--------

# FastAPI后端

-------------

## 部署

1. 上传总fastapi文件

2. 在宝塔面板->网站->Python项目->添加python项目->选择gunicorn运行方式

3. 添加所需要的数据库

   1.  ![image-20231005010839766](assets/image-20231005010839766.png)

4. 安装module(tortoise版本要合适才行,之后再补充)

   1.  ![image-20231005012529223](assets/image-20231005012529223.png)

5. ### 调整配置

   1. 在列表中找到刚才建的FastAPI项目
   2. 在这一行状态列中点击"运行中"将服务关闭
   3. 点击配置
   4. 默认为`worker_class = 'geventwebsocket.gunicorn.workers.GeventWebSocketWorker'`
   5. 修改为`worker_class = 'uvicorn.workers.UvicornWorker'`
   6. 重新启动项目

6. 如顺利,继续配置代码

   1. ```py
      # 数据库绑定
      register_tortoise(
          app=app,
          db_url='mysql://fastapi:123456@localhost:3306/fastapi',
          modules={'models': ['dao.models']},
          add_exception_handlers=True,
          generate_schemas=True
      )
      #添加中间件
      app.add_middleware(
          #CORSMiddleware,
          allow_origins=["*"],
          allow_credentials=True,
          allow_methods=["*"],
          allow_headers=["*"],
      )
      ```

## 跨域问题

### 后端解决

- 到main.py中添加中间件

```py
#引入中间件
from fastapi.middleware.cors import CORSMiddleware

#添加CORS中间件
app.add_middleware(
    ...
    CORSMiddleware,
	...
)
```

